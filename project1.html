<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n-key="pageTitle">Project Details: Linker EG</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <template id="gallery-item-template">
      <div class="gallery-item">
        <p class="media-caption"></p>
        <button class="see-more-btn" data-i18n-key="seeMore"></button>
        <video autoplay loop muted playsinline>
          <source src="" type="video/mp4" />
          Your browser does not support the video tag.
        </video>
      </div>
    </template>

    <div class="container">
      <header class="project-detail-header">
        <div class="language-switcher">
          <button id="lang-en-btn">English</button>
          <button id="lang-ar-btn">العربية</button>
        </div>
        <h1 data-i18n-key="headerTitle"></h1>
        <p data-i18n-key="headerDescription"></p>
      </header>

      <main class="project-detail-content">
        <div class="feature-spotlight">
          <h4 data-i18n-key="feature1Title"></h4>
          <p
            class="feature-description"
            data-i18n-key="feature1Description"
          ></p>
          <div class="feature-media-gallery" id="login-gallery"></div>
        </div>
        <div class="feature-spotlight">
          <h4 data-i18n-key="feature2Title"></h4>
          <p
            class="feature-description"
            data-i18n-key="feature2Description"
          ></p>
          <div class="feature-media-gallery" id="registration-gallery"></div>
        </div>
        <div class="feature-spotlight">
          <h4 data-i18n-key="feature3Title"></h4>
          <p
            class="feature-description"
            data-i18n-key="feature3Description"
          ></p>
          <div class="feature-media-gallery" id="profiles-gallery"></div>
          <div class="side-by-side-container">
            <h5 data-i18n-key="feature3ComparisonTitle"></h5>
            <p data-i18n-key="feature3ComparisonDescription"></p>
            <img
              src="assets/images/all-profiles-comparison.jpg"
              alt="Side-by-side comparison of Guest, Player, and Coach views"
            />
          </div>
        </div>
        <div class="feature-spotlight">
          <h4 data-i18n-key="feature4Title"></h4>
          <p
            class="feature-description"
            data-i18n-key="feature4Description"
          ></p>
          <div class="feature-media-gallery" id="search-filter-gallery"></div>
        </div>
        <div class="feature-spotlight">
          <h4 data-i18n-key="feature5Title"></h4>
          <p
            class="feature-description"
            data-i18n-key="feature5Description"
          ></p>
          <div class="feature-media-gallery" id="become-coach-gallery"></div>
        </div>
        <div class="feature-spotlight">
          <h4 data-i18n-key="feature6Title"></h4>
          <p
            class="feature-description"
            data-i18n-key="feature6Description"
          ></p>
          <div class="feature-media-gallery" id="session-gallery">
            <div class="gallery-item">
              <p
                class="media-caption"
                data-i18n-key="staticImageData.sessionSync.caption"
              ></p>
              <button class="see-more-btn" data-i18n-key="seeMore"></button>
              <img
                src="assets/images/linker-players-Joined.jpg"
                alt="Screenshot of the coach's view showing the enrolled player"
              />
            </div>
          </div>
        </div>
      </main>

      <a
        href="index.html"
        class="back-to-home-link"
        data-i18n-key="backToHome"
      ></a>
    </div>

    <script>
      let translations = {};

      function translatePage() {
        if (!translations || Object.keys(translations).length === 0) return;
        const currentLang = localStorage.getItem("lang") || "en";
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

        document.querySelectorAll("[data-i18n-key]").forEach((element) => {
          const key = element.getAttribute("data-i18n-key");
          const value = key
            .split(".")
            .reduce(
              (obj, k) => (obj && obj[k] !== undefined ? obj[k] : undefined),
              translations
            );
          if (value !== undefined) element.innerHTML = value;
        });

        document
          .querySelectorAll(".feature-media-gallery")
          .forEach((gallery) => (gallery.innerHTML = ""));
        const sessionGallery = document.getElementById("session-gallery");
        if (sessionGallery) {
          sessionGallery.innerHTML = `<div class="gallery-item">
                    <p class="media-caption" data-i18n-key="staticImageData.sessionSync.caption">${translations.staticImageData.sessionSync.caption}</p>
                    <button class="see-more-btn" data-i18n-key="seeMore">${translations.seeMore}</button>
                    <img src="assets/images/linker-players-Joined.jpg" alt="Screenshot of the coach's view" />
                </div>`;
        }

        createGallery("login-gallery", translations.loginGalleryData || []);
        createGallery(
          "registration-gallery",
          translations.registrationGalleryData || []
        );
        createGallery(
          "profiles-gallery",
          translations.profilesGalleryData || []
        );
        createGallery(
          "search-filter-gallery",
          translations.searchFilterGalleryData || []
        );
        createGallery(
          "become-coach-gallery",
          translations.becomeCoachGalleryData || []
        );
        createGallery("session-gallery", translations.sessionGalleryData || []);

        applySeeMoreLogic();
      }

      function loadLanguage(lang) {
        const oldScript = document.getElementById("lang-script");
        if (oldScript) oldScript.remove();

        const script = document.createElement("script");
        script.id = "lang-script";
        script.src = `lang/${lang}.js`;
        script.onload = () => {
          localStorage.setItem("lang", lang);
          translatePage();
        };
        script.onerror = () =>
          console.error(`Failed to load language file: ${script.src}`);
        document.head.appendChild(script);
      }

      document
        .getElementById("lang-en-btn")
        .addEventListener("click", () => loadLanguage("en"));
      document
        .getElementById("lang-ar-btn")
        .addEventListener("click", () => loadLanguage("ar"));

      function createGallery(containerId, data) {
        const galleryContainer = document.getElementById(containerId);
        const template = document.getElementById("gallery-item-template");
        if (!galleryContainer || !template || !data) return;
        data.forEach((itemData) => {
          const clone = template.content.cloneNode(true);
          clone.querySelector(".media-caption").innerHTML = itemData.caption;
          clone.querySelector("video source").src = itemData.videoSrc;
          galleryContainer.appendChild(clone);
        });
      }

      function applySeeMoreLogic() {
        const CHARACTER_LIMIT = 110;
        const galleryItems = document.querySelectorAll(".gallery-item");

        galleryItems.forEach((item) => {
          const caption = item.querySelector(".media-caption");
          const button = item.querySelector(".see-more-btn");
          if (!button) return;

          // Use a data attribute to prevent adding the same listener multiple times
          if (button.hasAttribute("data-listener-added")) return;

          // --- THIS IS THE FIX ---
          // We wrap the logic in a small delay to allow the browser to render
          setTimeout(() => {
            button.style.visibility = "hidden";
            caption.classList.remove("truncated");

            if (caption.textContent.length > CHARACTER_LIMIT) {
              button.style.visibility = "visible";
              caption.classList.add("truncated");
              button.textContent = translations.seeMore || "See More";
            }

            button.addEventListener("click", () => {
              caption.classList.toggle("truncated");
              button.textContent = caption.classList.contains("truncated")
                ? translations.seeMore || "See More"
                : translations.seeLess || "See Less";
            });
            button.setAttribute("data-listener-added", "true");
          }, 100); // 100ms delay
        });
      }

      loadLanguage(localStorage.getItem("lang") || "en");
    </script>
  </body>
</html>
